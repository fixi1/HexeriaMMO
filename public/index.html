<!DOCTYPE html>
<html>
<head>
  <title>Complex MMO</title>
  <meta charset="utf-8">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="left-panel" style="display:none;">
    <h2>INVENTORY</h2>
    <div id="weapons"></div>
    <div id="armor"></div>
    <div id="potions"></div>
    <div id="materials"></div>

    <h2>STATS</h2>
    <div id="stats">
      <p>HP: <span id="hp">100</span>/<span id="maxHp">100</span></p>
      <p>Mana: <span id="mana">50</span>/<span id="maxMana">50</span></p>
      <p>Level: <span id="level">1</span></p>
      <p>Gold: <span id="gold">0</span></p>
    </div>
    <button onclick="usePotion()">Use Potion</button>
  </div>

  <div id="game-area"></div>

  <div id="right-panel">
    <h2>CHAT</h2>
    <div id="chat-messages"></div>
    <input id="chat-input" placeholder="Type message..." onkeypress="if(event.key==='Enter') sendChat()">
    <button onclick="sendChat()">Send</button>

    <h2>CREATE CHARACTER</h2>
    <div class="customizer-group">
      <label>Name: <input id="char-name" value="Hero"></label>
      <label>Class:
        <select id="char-class">
          <option>Warrior</option>
          <option>Mage</option>
          <option>Rogue</option>
        </select>
      </label>
    </div>
    <button onclick="createCharacter()">Create & Play</button>
  </div>

  <script>
    let playerId = null;
    let myX = 100, myY = 100;
    const players = {};
    const socket = new WebSocket(`wss://${window.location.host}`);

    function createCharacter() {
      const name = document.getElementById('char-name').value.trim();
      if (!name) return alert("Name required!");
      socket.send(JSON.stringify({
        type: 'createPlayer',
        name,
        class: document.getElementById('char-class').value
      }));
    }

    socket.onmessage = (e) => {
      const msg = JSON.parse(e.data);
      
      if (msg.type === 'init') {
        playerId = msg.playerId;
        updateUI(msg.player);
        createPlayerElement(playerId, msg.player.x, msg.player.y, msg.player.name, msg.player.level, true);
      }
      else if (msg.type === 'playerJoined') {
        if (msg.player.id !== playerId) {
          createPlayerElement(msg.player.id, msg.player.x, msg.player.y, msg.player.name, msg.player.level, false);
        }
      }
      else if (msg.type === 'move') {
        if (msg.id !== playerId) movePlayer(msg.id, msg.x, msg.y);
      }
      else if (msg.type === 'attack') {
        showEffect(msg.targetId, `-${msg.damage}`, 'red');
      }
      else if (msg.type === 'healEffect') {
        showEffect(msg.id, `+${msg.amount}`, 'green');
      }
      else if (msg.type === 'playerKilled') {
        removePlayer(msg.victimId);
        setTimeout(() => {
          if (msg.victimId !== playerId) {
            // Re-adaugă jucătorul respawnat (simplificat)
            const victim = players[msg.victimId];
            if (victim) createPlayerElement(msg.victimId, 100, 100, victim.name, victim.level, false);
          }
        }, 3000);
      }
      else if (msg.type === 'respawn') {
        if (msg.id !== playerId) {
          movePlayer(msg.id, msg.x, msg.y);
        }
      }
      else if (msg.type === 'playerLeft') {
        removePlayer(msg.id);
      }
      else if (msg.type === 'chat') {
        addChatMessage(msg.name, msg.message);
      }
    };

    function updateUI(player) {
      document.getElementById('hp').innerText = player.hp;
      document.getElementById('maxHp').innerText = player.maxHp;
      document.getElementById('mana').innerText = player.mana;
      document.getElementById('maxMana').innerText = player.maxMana;
      document.getElementById('level').innerText = player.level;
      document.getElementById('gold').innerText = player.gold;
      document.getElementById('left-panel').style.display = 'block';
      document.getElementById('right-panel').style.display = 'block';
    }

    function createPlayerElement(id, x, y, name, level, isMe) {
      if (players[id]) {
        players[id].div.style.left = x + 'px';
        players[id].div.style.top = y + 'px';
        return;
      }

      const div = document.createElement('div');
      div.className = 'player';
      div.style.backgroundColor = isMe ? '#ff6b6b' : '#4cc9f0';
      div.style.left = x + 'px';
      div.style.top = y + 'px';

      const nameTag = document.createElement('div');
      nameTag.className = 'player-name';
      nameTag.innerText = `${name} [${level}]`;
      div.appendChild(nameTag);

      document.getElementById('game-area').appendChild(div);
      players[id] = { div, x, y, name, level };

      // Click pentru atac
      div.addEventListener('click', () => {
        if (isMe || !playerId) return;
        socket.send(JSON.stringify({ type: 'attack', targetId: id }));
      });
    }

    function movePlayer(id, x, y) {
      if (players[id]) {
        players[id].div.style.left = x + 'px';
        players[id].div.style.top = y + 'px';
        players[id].x = x;
        players[id].y = y;
      }
    }

    function removePlayer(id) {
      if (players[id]) {
        players[id].div.remove();
        delete players[id];
      }
    }

    function showEffect(id, text, color) {
      if (!players[id]) return;
      const effect = document.createElement('div');
      effect.className = 'effect';
      effect.innerText = text;
      effect.style.color = color;
      effect.style.left = (players[id].x + 16) + 'px';
      effect.style.top = (players[id].y) + 'px';
      document.getElementById('game-area').appendChild(effect);
      setTimeout(() => effect.remove(), 1000);
    }

    function addChatMessage(name, message) {
      const div = document.createElement('div');
      div.className = 'chat-message';
      div.innerHTML = `<strong>${name}:</strong> ${message}`;
      document.getElementById('chat-messages').appendChild(div);
      document.getElementById('chat-messages').scrollTop = 1e9;
    }

    function sendChat() {
      const input = document.getElementById('chat-input');
      const msg = input.value.trim();
      if (msg) {
        socket.send(JSON.stringify({ type: 'chat', message: msg }));
        input.value = '';
      }
    }

    function usePotion() {
      if (playerId) {
        socket.send(JSON.stringify({ type: 'usePotion' }));
      }
    }

    // Mișcare
    let keys = {};
    window.addEventListener('keydown', e => {
      if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)) {
        keys[e.key] = true;
        e.preventDefault();
      }
    });
    window.addEventListener('keyup', e => {
      if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)) {
        keys[e.key] = false;
        e.preventDefault();
      }
    });

    setInterval(() => {
      if (!playerId) return;
      let moved = false;
      const s = 5;
      if (keys['ArrowUp']) { myY -= s; moved = true; }
      if (keys['ArrowDown']) { myY += s; moved = true; }
      if (keys['ArrowLeft']) { myX -= s; moved = true; }
      if (keys['ArrowRight']) { myX += s; moved = true; }
      myX = Math.max(0, Math.min(768, myX));
      myY = Math.max(0, Math.min(568, myY));
      if (moved) {
        socket.send(JSON.stringify({ type: 'move', x: myX, y: myY }));
        movePlayer(playerId, myX, myY);
      }
    }, 1000/60);
  </script>
</body>
</html>
